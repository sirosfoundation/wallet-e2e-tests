# Wallet E2E Tests - Reusable Workflow
#
# This workflow tests wallet-frontend against go-wallet-backend using Docker Compose.
# It can be called from either repository to ensure compatibility.
#
# Default repositories:
#   Frontend: https://github.com/wwWallet/wallet-frontend.git
#   Backend:  https://github.com/sirosfoundation/go-wallet-backend.git
#
# Usage from wallet-frontend (or fork):
#   uses: sirosfoundation/wallet-e2e-tests/.github/workflows/e2e-tests.yml@main
#   with:
#     frontend-ref: ${{ github.sha }}
#     frontend-repo: ${{ github.repository }}
#     backend-refs: '["main", "v1.0.0"]'
#
# Usage from go-wallet-backend (or fork):
#   uses: sirosfoundation/wallet-e2e-tests/.github/workflows/e2e-tests.yml@main
#   with:
#     backend-ref: ${{ github.sha }}
#     backend-repo: ${{ github.repository }}
#     frontend-refs: '["master", "v1.0.0"]'

name: E2E Tests

on:
  workflow_call:
    inputs:
      # Single ref for the component being tested (from the calling repo)
      frontend-ref:
        description: 'Git ref for wallet-frontend (branch, tag, or SHA)'
        type: string
        required: false
        default: ''
      backend-ref:
        description: 'Git ref for go-wallet-backend (branch, tag, or SHA)'
        type: string
        required: false
        default: ''
      # Multiple refs to test against (JSON array)
      frontend-refs:
        description: 'JSON array of frontend refs to test against'
        type: string
        required: false
        default: '[]'
      backend-refs:
        description: 'JSON array of backend refs to test against'
        type: string
        required: false
        default: '[]'
      # Repository names (owner/repo format, for forks)
      frontend-repo:
        description: 'GitHub repository for wallet-frontend (owner/repo)'
        type: string
        required: false
        default: 'wwWallet/wallet-frontend'
      backend-repo:
        description: 'GitHub repository for go-wallet-backend (owner/repo)'
        type: string
        required: false
        default: 'sirosfoundation/go-wallet-backend'
      # Test configuration
      test-filter:
        description: 'Playwright test filter (e.g., "@prf" or "@registration")'
        type: string
        required: false
        default: ''
      timeout-minutes:
        description: 'Job timeout in minutes'
        type: number
        required: false
        default: 30
    outputs:
      result:
        description: 'Test result summary'
        value: ${{ jobs.summarize.outputs.summary }}

  # Allow manual triggering from the Actions tab
  workflow_dispatch:
    inputs:
      frontend-ref:
        description: 'Frontend ref (branch/tag/SHA)'
        type: string
        default: 'master'
      backend-ref:
        description: 'Backend ref (branch/tag/SHA)'
        type: string
        default: 'main'
      frontend-repo:
        description: 'Frontend repository (owner/repo)'
        type: string
        default: 'wwWallet/wallet-frontend'
      backend-repo:
        description: 'Backend repository (owner/repo)'
        type: string
        default: 'sirosfoundation/go-wallet-backend'
      test-filter:
        description: 'Test filter (optional)'
        type: string
        default: ''

jobs:
  # Build the test matrix from inputs
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: Build test matrix
        id: build-matrix
        shell: bash
        run: |
          # Parse inputs
          FRONTEND_REF="${{ inputs.frontend-ref }}"
          BACKEND_REF="${{ inputs.backend-ref }}"
          FRONTEND_REFS='${{ inputs.frontend-refs }}'
          BACKEND_REFS='${{ inputs.backend-refs }}'
          
          # Default refs if none specified
          if [ -z "$FRONTEND_REF" ] && [ "$FRONTEND_REFS" = "[]" ]; then
            FRONTEND_REF="master"
          fi
          if [ -z "$BACKEND_REF" ] && [ "$BACKEND_REFS" = "[]" ]; then
            BACKEND_REF="main"
          fi
          
          # Build matrix JSON
          if [ -n "$FRONTEND_REF" ] && [ "$BACKEND_REFS" != "[]" ]; then
            # Testing frontend against multiple backends
            MATRIX=$(echo "$BACKEND_REFS" | jq -c --arg f "$FRONTEND_REF" '{include: [.[] | {frontend: $f, backend: .}]}')
          elif [ -n "$BACKEND_REF" ] && [ "$FRONTEND_REFS" != "[]" ]; then
            # Testing backend against multiple frontends
            MATRIX=$(echo "$FRONTEND_REFS" | jq -c --arg b "$BACKEND_REF" '{include: [.[] | {frontend: ., backend: $b}]}')
          else
            # Single combination
            FRONTEND_REF="${FRONTEND_REF:-master}"
            BACKEND_REF="${BACKEND_REF:-main}"
            MATRIX=$(jq -n -c --arg f "$FRONTEND_REF" --arg b "$BACKEND_REF" '{include: [{frontend: $f, backend: $b}]}')
          fi
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Test matrix: $MATRIX"

  # Run E2E tests for each matrix combination
  test:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes || 30 }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
      - name: Checkout E2E tests
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install test dependencies
        run: |
          npm ci
          npx playwright install chromium --with-deps

      - name: Checkout wallet-frontend
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.frontend-repo || 'wwWallet/wallet-frontend' }}
          ref: ${{ matrix.frontend }}
          path: wallet-frontend

      - name: Checkout go-wallet-backend
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.backend-repo || 'sirosfoundation/go-wallet-backend' }}
          ref: ${{ matrix.backend }}
          path: go-wallet-backend

      - name: Show versions
        run: |
          echo "Frontend: ${{ matrix.frontend }} from ${{ inputs.frontend-repo || 'wwWallet/wallet-frontend' }}"
          echo "Frontend SHA: $(cd wallet-frontend && git rev-parse HEAD)"
          echo "Backend: ${{ matrix.backend }} from ${{ inputs.backend-repo || 'sirosfoundation/go-wallet-backend' }}"
          echo "Backend SHA: $(cd go-wallet-backend && git rev-parse HEAD)"

      - name: Start services with Docker Compose
        run: |
          # Set paths for CI environment (repos checked out into current directory)
          export FRONTEND_PATH=./wallet-frontend
          export BACKEND_PATH=./go-wallet-backend
          
          # Copy our Dockerfile.e2e to the frontend directory
          cp -f dockerfiles/frontend.Dockerfile ./wallet-frontend/Dockerfile.e2e
          
          docker compose -f docker-compose.test.yml up -d --build
          
          echo "Waiting for services to be healthy..."
          for i in {1..120}; do
            if curl -sf http://localhost:3000 >/dev/null 2>&1 && \
               curl -sf http://localhost:8080/status >/dev/null 2>&1 && \
               curl -sf http://localhost:9000/health >/dev/null 2>&1 && \
               curl -sf http://localhost:9091/health >/dev/null 2>&1; then
              echo "All services are healthy!"
              break
            fi
            echo "  Waiting... ($i/120)"
            sleep 2
          done
          
          # Final health check
          curl -sf http://localhost:3000 || (echo "Frontend not ready"; exit 1)
          curl -sf http://localhost:8080/status || (echo "Backend not ready"; exit 1)
          curl -sf http://localhost:9000/health || (echo "Mock issuer not ready"; exit 1)
          curl -sf http://localhost:9091/health || (echo "Mock PDP not ready"; exit 1)
        env:
          FRONTEND_PATH: ./wallet-frontend
          BACKEND_PATH: ./go-wallet-backend

      - name: Run E2E tests
        run: |
          FILTER="${{ inputs.test-filter }}"
          if [ -n "$FILTER" ]; then
            npx playwright test --grep "$FILTER"
          else
            npx playwright test
          fi
        env:
          FRONTEND_URL: http://localhost:3000
          BACKEND_URL: http://localhost:8080
          MOCK_ISSUER_URL: http://localhost:9000
          TRUST_PDP_URL: http://localhost:9091
          ADMIN_TOKEN: e2e-test-admin-token-for-testing-purposes-only
          CI: true

      - name: Show service logs
        if: always()
        run: |
          echo "=== Docker Compose Service Status ==="
          docker compose -f docker-compose.test.yml ps
          echo ""
          echo "=== Backend logs ==="
          docker compose -f docker-compose.test.yml logs wallet-backend || true
          echo ""
          echo "=== Frontend logs ==="
          docker compose -f docker-compose.test.yml logs wallet-frontend || true

      - name: Stop services
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

      - name: Sanitize artifact names
        id: sanitize
        if: always()
        run: |
          # Replace slashes with dashes for artifact names
          FRONTEND_SAFE=$(echo "${{ matrix.frontend }}" | tr '/' '-')
          BACKEND_SAFE=$(echo "${{ matrix.backend }}" | tr '/' '-')
          echo "frontend=$FRONTEND_SAFE" >> $GITHUB_OUTPUT
          echo "backend=$BACKEND_SAFE" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ steps.sanitize.outputs.frontend }}-${{ steps.sanitize.outputs.backend }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: Upload test report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ steps.sanitize.outputs.frontend }}-${{ steps.sanitize.outputs.backend }}
          path: playwright-report/
          retention-days: 30

  # Summarize results
  summarize:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    outputs:
      summary: ${{ steps.summary.outputs.summary }}
    steps:
      - name: Generate summary
        id: summary
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | Backend | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "summary=All tests passed" >> $GITHUB_OUTPUT
            echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "summary=Some tests failed" >> $GITHUB_OUTPUT
            echo "❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
