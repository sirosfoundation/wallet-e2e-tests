# Docker Compose for Wallet E2E Testing
#
# This configuration allows testing different combinations of
# wallet-frontend and go-wallet-backend versions.
#
# Usage:
#   # Test with specific versions
#   FRONTEND_VERSION=v1.0.0 BACKEND_VERSION=v1.0.0 docker-compose up
#
#   # Or use local builds
#   docker-compose -f docker-compose.yml -f docker-compose.local.yml up

version: '3.8'

services:
  wallet-backend:
    image: ghcr.io/sirosfoundation/go-wallet-backend:${BACKEND_VERSION:-latest}
    container_name: wallet-backend-e2e
    ports:
      - "8080:8080"
      - "8081:8081"  # Admin API port for tenant management
    environment:
      - WALLET_JWT_SECRET=test-secret-for-e2e-testing-minimum-32-chars
      - WALLET_SERVER_WEBAUTHN_DISPLAY_NAME=Wallet E2E Test
      - WALLET_SERVER_RP_ID=localhost
      - WALLET_SERVER_RP_ORIGIN=http://localhost:3000
      - WALLET_SERVER_ENABLE_CREDENTIAL_REGISTRATION=true
      - WALLET_SERVER_REQUIRE_USER_VERIFICATION=true
      - WALLET_SERVER_TIMEOUT=60000
      - WALLET_SERVER_ATTESTATION=none
      - WALLET_SERVER_PORT=8080
      - WALLET_SERVER_ADMIN_PORT=8081
      - WALLET_LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/status"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - wallet-network

  wallet-frontend:
    image: ghcr.io/sirosfoundation/wallet-frontend:${FRONTEND_VERSION:-latest}
    container_name: wallet-frontend-e2e
    ports:
      - "3000:3000"
    environment:
      - VITE_WALLET_BACKEND_URL=http://wallet-backend:8080
      - VITE_WEBAUTHN_RPID=localhost
      - VITE_LOGIN_WITH_PASSWORD=false
    depends_on:
      wallet-backend:
        condition: service_healthy
    networks:
      - wallet-network

  # Optional: Run tests in container
  e2e-tests:
    build:
      context: .
      dockerfile: Dockerfile.tests
    container_name: wallet-e2e-tests
    environment:
      - FRONTEND_URL=http://wallet-frontend:3000
      - BACKEND_URL=http://wallet-backend:8080
    depends_on:
      - wallet-frontend
    volumes:
      - ./test-results:/app/test-results
      - ./playwright-report:/app/playwright-report
    networks:
      - wallet-network
    profiles:
      - tests

networks:
  wallet-network:
    driver: bridge
