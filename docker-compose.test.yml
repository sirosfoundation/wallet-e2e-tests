# Docker Compose for E2E Tests
#
# All-in-one test environment: frontend, backend, and mock services.
#
# Usage:
#   make up              # Build and start all services
#   make run             # Run all E2E tests
#   make down            # Stop all services
#   make ci-docker       # Full cycle: up, run, down
#
# Or directly:
#   docker-compose -f docker-compose.test.yml up -d --build
#   npx playwright test
#   docker-compose -f docker-compose.test.yml down
#
# Configuration (via environment variables):
#   BACKEND_PATH  - Path to go-wallet-backend source
#                   Local: ../go-wallet-backend (default)
#                   CI:    ./go-wallet-backend
#   FRONTEND_PATH - Path to wallet-frontend source
#                   Local: ../wallet-frontend (default)
#                   CI:    ./wallet-frontend

services:
  # Wallet Frontend - React app served via nginx
  wallet-frontend:
    build:
      context: ${FRONTEND_PATH:-../wallet-frontend}
      dockerfile: ${DOCKERFILE_PATH:-${PWD}/dockerfiles/frontend.Dockerfile}
      args:
        - VITE_WALLET_BACKEND_URL=http://localhost:8080
        - VITE_WS_URL=ws://localhost:8080
        - VITE_WEBAUTHN_RPID=localhost
        - VITE_OPENID4VCI_REDIRECT_URI=http://localhost:3000/
        - VITE_STATIC_PUBLIC_URL=http://localhost:3000
        - VITE_STATIC_NAME=E2E Test Wallet
    image: wallet-frontend-e2e-test:local
    container_name: wallet-frontend-e2e-test
    ports:
      - "3000:80"
    depends_on:
      - wallet-backend
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - e2e-test-network

  # Go Wallet Backend - built from local source
  wallet-backend:
    build:
      context: ${BACKEND_PATH:-../go-wallet-backend}
      dockerfile: Dockerfile
    image: wallet-backend-e2e-test:local
    container_name: wallet-backend-e2e-test
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      - WALLET_JWT_SECRET=test-secret-for-e2e-testing-minimum-32-chars
      - WALLET_SERVER_WEBAUTHN_DISPLAY_NAME=E2E Test Wallet
      - WALLET_SERVER_RP_ID=localhost
      - WALLET_SERVER_RP_ORIGIN=http://localhost:3000
      - WALLET_SERVER_PORT=8080
      - WALLET_SERVER_ADMIN_PORT=8081
      - WALLET_SERVER_ADMIN_TOKEN=e2e-test-admin-token-for-testing-purposes-only
      - WALLET_LOG_LEVEL=debug
      - WALLET_TRUST_PDP_URL=http://mock-trust-pdp:9091
      - WALLET_TRUST_ENABLED=true
    # Map localhost to mock services for discovery requests
    extra_hosts:
      - "localhost:host-gateway"
    depends_on:
      mock-issuer:
        condition: service_healthy
      mock-trust-pdp:
        condition: service_healthy
    # Note: distroless image has no shell/wget, healthcheck done by make up
    networks:
      - e2e-test-network

  # Mock OpenID4VCI Credential Issuer
  mock-issuer:
    build:
      context: ./mocks/issuer
      dockerfile: Dockerfile
    image: mock-issuer-e2e-test:local
    container_name: mock-issuer-e2e-test
    ports:
      - "9000:9000"
    environment:
      - PORT=9000
      - ISSUER_ID=http://localhost:9000
      - INCLUDE_IACA=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9000/health"]
      interval: 3s
      timeout: 3s
      retries: 10
    networks:
      - e2e-test-network

  # Mock AuthZEN Trust PDP
  mock-trust-pdp:
    build:
      context: ./mocks/trust-pdp
      dockerfile: Dockerfile
    image: mock-trust-pdp-e2e-test:local
    container_name: mock-trust-pdp-e2e-test
    ports:
      - "9091:9091"
    environment:
      - PORT=9091
      - PDP_ID=http://localhost:9091
      - TRUSTED_ISSUERS=http://localhost:9000,http://mock-issuer:9000
      - TRUSTED_VERIFIERS=http://localhost:9001
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9091/health"]
      interval: 3s
      timeout: 3s
      retries: 10
    networks:
      - e2e-test-network

networks:
  e2e-test-network:
    driver: bridge
